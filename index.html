<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="UTF-8">
<title>ინგლისურის IPA თარგმანი</title>
<link rel="icon" type="image/png" href="/favicon.png">
<style>
body {
  background: #2e3b4e;
  color: #fff;
  font-family: Arial, sans-serif;
  padding: 20px;
}
textarea {
  width: 100%;
  height: 150px;
  background: rgba(255,255,255,0.05);
  color: #fff;
  border: none;
  padding: 10px;
  border-radius: 8px;
  font-size: 16px;
}
button {
  padding: 8px 14px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  margin-left: 5px;
  border: none;
}
button.convert {
  background: #e53935;
  color: #fff;
}
.output {
  background: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 8px;
  white-space: pre-wrap;
  margin-top: 10px;
}
.line {
  margin-bottom: 6px;
}
.en { color: #f5f5f5; font-weight: 300; font-size: 16px; }
.ipa { color: #fff; font-weight: 600; font-size: 16px; }
.ka { color: #e0e0e0; font-weight: 400; font-size: 16px; }
.controls { margin-bottom: 15px; }
</style>
</head>
<body>

<h2>ინგლისურის IPA თარგმანი</h2>

<textarea id="text" placeholder="აკრიფე ინგლისური ტექსტი აქ..."></textarea><br>

<div class="controls">
<label>ხმის მოდელები: <select id="voiceSelect"></select></label>
<label>სიჩქარე: <input type="number" id="rate" min="0.5" max="2" step="0.1" value="1"></label>
<button onclick="playAll()">▶</button>
<button onclick="stopAll()">⏹</button>
<button class="convert" onclick="convertAndTranslate()">Convert</button>
</div>

<div id="output" class="output"></div>

<script>
// IPA dictionary
const ldoceDict = {
  "time":"taɪm","moves":"muːvz","in":"ɪn","spirals":"ˈspaɪrəlz",
  "we":"wiː","are":"ɑː","flotsam":"ˈflɒtsəm","on":"ɒn",
  "sea":"siː","and":"ænd","repeats":"rɪˈpiːts","its":"ɪts",
  "tragedies":"ˈtrædʒədiz","time’s":"taɪmz"
};
function getIPA(line) {
  return line.split(/\s+/).map(w=>{
    const clean = w.replace(/[.,;!?]/g,"").toLowerCase();
    return ldoceDict[clean] || w;
  }).join(" ");
}

// Convert + Translate
async function convertAndTranslate() {
  const text = document.getElementById("text").value.trim();
  if (!text) return alert("Please enter text.");

  try {
    const res = await fetch("/.netlify/functions/translate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    if (data.error) return alert("Error: " + data.error);

    const lines = text.split(/\n/);
    const translations = data.translation.split(/\n/);
    const outputDiv = document.getElementById("output");
    outputDiv.innerHTML = "";

    lines.forEach((line, idx) => {
      const ipaLine = getIPA(line);
      const kaLine = translations[idx] || "";
      const div = document.createElement("div");
      div.className = "line";
      div.innerHTML = `
        <span class="en">${line}</span>
        <button onclick="playLine('${line.replace(/'/g,"\\'")}')">▶</button><br>
        <span class="ipa">${ipaLine}</span><br>
        <span class="ka">${kaLine}</span>
      `;
      outputDiv.appendChild(div);
    });
  } catch (err) {
    alert("Translation failed: " + err.message);
  }
}

// TTS setup
let synth = window.speechSynthesis;
let voices = [];
function populateVoiceList() {
  voices = synth.getVoices();
  const select = document.getElementById('voiceSelect');
  select.innerHTML = "";
  voices.forEach((voice, i)=>{
    const option = document.createElement('option');
    option.textContent = voice.name + " ("+voice.lang+")";
    option.value = i;
    select.appendChild(option);
  });
}
populateVoiceList();
if(speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoiceList;

function playLine(text) {
  const utter = new SpeechSynthesisUtterance(text);
  const select = document.getElementById('voiceSelect');
  utter.voice = voices[select.value];
  utter.rate = parseFloat(document.getElementById('rate').value);
  synth.speak(utter);
}
function playAll() {
  const txt = document.getElementById("text").value;
  playLine(txt);
}
function stopAll() {
  synth.cancel();
}
</script>

</body>
</html>
